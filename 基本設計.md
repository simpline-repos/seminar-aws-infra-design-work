# 基本設計

基本設計とは、

## 基本設計のインプット・アウトプット
### インプット
前段階の成果物全てがインプットになるが、特に以下が無いと基本設計が行き詰まる。
- 非機能要件定義書

上記では足りないのが殆どなので、このフェーズでも議論や提案は必要

### アウトプット(成果物)
- 基本設計書


## 基本設計で記述すること
基本的に要件定義で出てきた要件をどのような方式・方針で実現するのかを記述するのが基本設計です。<br>
内容として求められるのは、これをインプットに詳細設計を書いていくことが出来ようにすることです。基本設計が完了したら、詳細設計の枠は過不足なく出来る状態になっているべきです。具体的には最低限以下のようなことが書いてあるべきです。
- システムを構成する要素と役割を漏れなく(詳細設計に書くサービス種別・数が決まります)
- 必須設定項目、デフォルト値と異なるオプション設計項目(各サービスについて、詳細設計に書く項目が決まります)
上記に加えて、以下もある程度書いてあるべきです
- それぞれの設計項目のパラメータを決定する為の要件(パラメータ値を決定する材料になります)

### 基本設計で注意するべきこと
PMやPLが注意するべき事、前提として聞いておいた方が良い事等
- 非機能要件定義書をもらいましょう
- メンバーと完成イメージを共有しましょう
- メンバーに書いてもらいたいことを具体的に指示しましょう。必要に応じてドラフトを書いてあげましょう。

メンバー・リーダーみんな気を付けるべきこと
- 詳細設計のインプットとなるようにある程度具体的な内容まで書きましょう
- 書いたら自分で読み返して、詳細設計としてどんな項目を書くことになるかイメージ出来るか確認しましょう

### 章立て
- システムの目的
- システム概要
    - システム構成図
    - ソフトウェア一覧
    - 命名規則
    - タグ
- AWSアカウント設計
    - アカウントセキュリティ
    - IAM ユーザ
- ネットワーク設計
    - VPC・サブネット構成
    - WAN通信
    - AWS API通信
    - インターネット通信
    - ネットワークセキュリティ
    - DNS,NTPのようなネットワーク基本設計
    - ドメイン
- サーバ系要件
    - 計算基盤
    - サーバ構成
    - OS
    - ミドルウェア
    - アプリケーションサーバ
    - DB
    - LB
    - CDN
    - ストレージ
- 非機能系要件
    - 可用性
        - 稼働率
        - RPO/RTO/RLO
        - BCP・DR
    - 性能・拡張性
        - オンライン性能
        - バッチ性能
        - 性能拡張
        - 容量拡張
    - セキュリティ
        - 脆弱性対策（パッチ）
	    - ウィルス対策
        - 攻撃防御どんな攻撃を想定するか、どんな対策をするか
        - 暗号化
        - 監査
    - 保守・運用性
        - 監視
        - ログ
            - 取得・保管対象ログ
                - アクセス分析系
                - 障害調査系
                - 監査系
            - 保管要件
                - 期間
                - 暗号化有無
        - バックアップ・リストア

以下から
---

# システムの目的
誰に何を提供するのが目的というようなことを書きます。以下のような要素が適宜入っていればいいんではないかと。
- システム主幹（誰が）
- 主なエンドユーザ（誰に）
- どんな機能を提供するのか（何を・どんなことを）
- 非機能について特筆することがあれば（どうやって）
- 補足情報があれば必要に応じて（Why, Where, When）

# システム概要
システムの全体像だったり、共通で適用できるような設計事項を書きます。

## システムの構成図
この設計書の中で設計するもの達を１枚以上の構成図で示します。1枚で収まるなら1枚で、規模が大きくて複数枚に分けないと描ききれないのであれば複数枚に分けるといいでしょう。例えば以下のような図があると思います。
- VPCの中だけの図
- AWSアカウント内のその他リソースも含めた図
- WANや外部連携先も含めた図
システムの利用者がどこからアクセスしてくるのか、運用保守のオペレータがどこからアクセスしてくるのかも分かるとよいでしょう。

## ソフトウェア一覧
システムで利用するソフトウェアの一覧です。OSに追加でインストールするミドルウェアや、パッケージソフトの一覧表を作ります。継続的に更新がかかるような環境ではソフトのバージョン番号までは書かない方が良いです。（個人的にはソフトウェア一覧は不要論を唱えています。サポート切れや脆弱性のあるソフトがないかのチェックに主に使われる資料だと思いますが、昨今のAWS環境ではSSMのインベントリとかで確認するのが良いんじゃないかなぁ......）

## 命名規則
各リソースにどんな命名をするのかです。正直これが一番難しいんじやないかな。。。どんなリソースにも適用できる1つのパターンを作ろうとすると詰むので、なにはこういうパターンで命名するというようなものを作成することになるかと。AWSリソースの命名に加えて、コンピュータのホスト名も命名する場合があります。<br>
注意すべきは、名前に使える文字の種類（大文字や、一部の記号、非アルファベット文字が使えるかどうか。AWSリソースによって使えたり使えなかったりするので注意が必要）や文字数（例えば、Windowsのホスト名は15文字まで、ALB名は32文字まで等）の制約です。

## タグ設計
各AWSリソースにどんなタグ付けをするのかを書きます。まず、どんな目的でタグをつけるよという事を決めて書きます。そして、タグキーの一覧と値の例を表にしてあげます。タグを付ける目的については、お客さんと相談することになりますが、タグの利用目的が決めきれなそうであれば詳細は運用設計で定義するとしてしまっても良いです。<br>
以下は代表的なタグの目的です。適宜取捨選択。
- コスト配分
- リソース整理
- 自動化
- アクセス制御

参考
- [AWSリソースのタグ付け](https://docs.aws.amazon.com/ja_jp/general/latest/gr/aws_tagging.html)


# AWSアカウント設計
AWSアカウントの、構成、IAMユーザ、セキュリティ・コンプライアンス系サービスといった、システムの機能に関わらない部分の設計を記述します。

## AWSアカウント構成
マルチアカウント構成にするのであればアカウント設計は別のドキュメントに纏めるのでも良いと思います。

## AWSリージョン構成
AWSリージョンの利用に関する方針

## IAMユーザ
IAMユーザ・グループ・ポリシー設計
運用設計で設計することにしても良いと思います。

## アカウントセキュリティ・コンプライアンス
CloudTrail,AWS Config,GuardDuty,Macie等
運用設計で設計する事にしても良いと思います。


# ネットワーク設計
VPCやDirectConnect、インターネット接続やセキュリティグループといったネットワークに関する設計です。

## ネットワーク構成概要
まず、インターネット,WANを含むシステムのネットワークの全体像と基本的なネットワーク要件（外部接続先、NWセキュリティの方針）を描きます。
- 概要説明
- ネットワーク構成図

## VPC・サブネット構成
VPCとサブネットの構成を書きます。

### VPC設計
VPCとそのCIDRについて書きます。

### サブネット設計
サブネットとそのCIDR,Availability Zone
各サブネットが他のどんなネットワークと通信出来るか

## WAN通信
各VPCが通信するVPC外のプライベートネットワーク
それらと何を介して繋げるか(VyOS等でのセルフマネージドVPN,AWSマネージドVPN, DirectConnect, DX Gateway, Transit Gateway)

## VPC Endpoint
VPC Endpointに関する設計
- VPCエンドポイント一覧（サービス・Gateway型かインタフェース型か）
- VPCエンドポイントポリシーを設定するか、設定するならどんなポリシーか
- インタフェース型VPCエンドポイントについては、AZ構成、プライベートDNS名オプションを有効にするか
## インターネット通信
インターネットへの接続方法、
## ネットワーク通信要件
これまで挙げて来たサブネットとVPC外ネットワークとの間の通信要件(通信できるようにする・しない)を整理して、通信制御方針、つまりルートテーブル・NACL・SGをどのように組み合わせて通信要件を実現するのかを設計します。
- 通信要件まとめ
- 通信制御方針
- ルートテーブル
- NACL
- SG

## ログ
ネットワーク関係のログについてです。取る取らないという要件は要件定義のログ要件で定義したものです。ここがまだ決まっていないのであれば、基本設計フェーズで決めるか、運用設計フェーズで決めるということになります。
VPC Flow Logs
Route53 resolver log

## ネットワーク基本設定(DNS,NTP等)
DHCPオプションセット
DNS系設定について

## ドメイン
DNSのドメインやActive Directory Domain Serviceについての設計です。<br>
*TODO*
### パブリックドメイン
パブリックドメイン（インターネットから解決できるDNS名）をシステムに割り当てるのであれば書くべき項目です。パブリックドメインを使って、どのようにシステムの名前をユーザーに解決してもらうかの設計を設計します。以下のようなことを書きます。
- 取得するドメインの名前
- ドメインをホストするDNSサービス(基本はRoute53のパブリックホステッドゾーンかと)
- サービスのFQDN（すべてのレコードを書く必要はないです。それは詳細設計に書くか台帳を作るかで良いかと）
- その他レコードの設定方法に特記事項があれば(例: Aliasレコード、フェイルオーバー設定、etc.)

この際に注意するべきなのは、[Zone Apex(ネイキッドドメイン)](https://e-words.jp/w/Zone_Apex.html)に、CNAMEレコードを登録するように設計しないことです。Zone ApexにCNAMEレコードを設定することは出来ない為です。CloudFrontやELBとRoute53の組み合わせであればAliasレコード(実質Aレコード)で対応出来ますが、それ以外の組み合わせの時には気を付けた方が良いです。

### ローカルドメイン
ローカルドメイン(VPC内部のみ、もしくはDX等で繋がったWAN内のみで解決出来るドメイン名)を用意するのであれば書くべき章です。ローカルドメインを用意す場合にも以下の2種類が考えられます。

| ローカルドメイン                | 説明                                                                                                                                                   | 
| ------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------ | 
| Active Directoryドメイン        | WindowsのActive Directory Domain Servicesによるドメインです。DNSのローカルドメインも兼ねます。基本ドメインコントローラーがVPC内のDNSサーバとなります。 | 
| Route53 Privateホステッドゾーン | DNSのローカルドメインです。Route53でVPC群に紐づけたプライベートホステッドゾーンを作ることになります。                                                  | 

以下のようなことを書きます。
- 何の為にローカルドメインを用意するのか(目的)
- ローカルドメインを上表のどちら(AD?Route53?)で実装するのか
    - ADドメインの場合は、ドメインコントローラーは何か(Directory Service, EC2, オンプレADサーバ)
- ローカルドメインのドメイン名
- ローカルドメイン名が解決できるネットワークの範囲

ここで注意すべきは、特にADドメインを用意する場合です。
- AWS Directory Serviceではドメインは新規に作成となり、オンプレのドメインと同一にすることは出来ません。オンプレドメインと連携するには[外部またはフォレストの信頼関係](https://viewse.blogspot.com/2012/11/vs.html)を結ぶ必要があります。[サイト](https://blogs.manageengine.jp/what_is_site/)は構成出来ません。当然設計することは増えます。
- AWS Directory Serviceでは、ドメインの管理者は真のDomainAdminsではありません。これはマネージドサービスであるが故の制約ですが、ドメインを運用していくのに十分な権限が管理者アカウントには付与されています。とはいえ、上記の制約も含めてドキュメントで詳しく調べて要件に合うかを検討するべきです。
- EC2,オンプレADサーバとする場合は、可用性設計が重要です。ドメインコントローラーはコアコンポーネントであり、障害が起こるとシステム全体が機能停止に陥る可能性が高いです。ゆえに高い可用性が必要です。
    - EC2の場合は、ドメコンサーバは冗長構成を取るというような設計となるかと
    - オンプレADサーバの場合は、VPCからオンプレへのネットワークには高い可用性を確保する設計となるかと


# アプリケーションサービス設計
サービスを構成するロードバランサーやサーバー、データベース等の設計です。どんなサーバ群でサービスを提供するかを設計します。また、それらのパラメータを決定する為の方針を定めます。<br>
ここから先は、システムの規模や基盤によって色々なバリエーションが出てくるゾーンに入ってきます。なので、章立ては参考程度にしてもらって、システム毎にどのような章立てが良いか考えて貰った方が良いかと思います。例えば、場合によってはシステムがいくつかのサービスに分かれていることもあると思います。その場合は、サービス毎に別々の章に分けるという章立ても検討すると良いかと。

## 概要
アプリケーション基盤としてどんな構成にするか、基本方針を示します。

### 計算基盤
計算基盤として何を使用するかを書きます。
EC2インスタンスなのか、コンテナ（ECSかEKSか。データプレーンはEC2かFargateか）、Lambdaを使ってサーバレスかといったことを書きます。

### サーバ構成
アプリケーションのサービスがどんなサーバ等で構成されるかを記述します。
- アプリケーションサービス構成図(CDN, Load Balancer含む)
- サーバ一覧表

サーバ一覧のレベル感は、例えば以下のような感じで良いかなと

| サーバ                 | 基盤・サービス            | 台数                          | 備考（あれば） | 
| ---------------------- | ------------------------- | ----------------------------- | -------------- | 
| CDN                    | CloudFront                | 1                             |                | 
| Webサーバ              | S3                        | 1                             |                | 
| ロードバランサー       | Application Load Balancer | 1                             |                | 
| アプリケーションサーバ | EC2                       | 2台以上（Auto Scaling Group） |                | 
| BIサーバ               | EC2                       | 1                             |                | 
| DBサーバ               | RDS                       | マルチAZ 1台                  |                | 
| 分析用DBサーバ         | RDSリードレプリカ         | シングルAZ 1台                |                | 

## コンテナオーケストレーション設計
ECSやEKSのようなコンテナオーケストレータを使う場合は書くべき章です。
- コントロールプレーン(コンテナオーケストレーター)としてなにを選ぶか(ECSかKubernetesかの2択)、マネージドサービスを使うか
- データプレーンとしてなにを使用するか(EC2 or Fargate)
- コンテナイメージレポジトリとしてなにを使用するか(プライベートに使うと思うんで基本ECR一択かなと)
### クラスター設計
- クラスターをどんな単位で構築するか
- クラスターのバージョン選択方針
### データプレーン設計
EC2インスタンスを選ぶなら
Fargateを選ぶなら

### コンテナレジストリ設計
### IAM Role

## EC2インスタンス設計
コンテナを使わず、EC2インスタンス上にアプリをデプロイする場合に書く章です。EC2インスタンス関する設計を記していく章です。まずはサーバ共通の設計をしてから、各役割別に異なる部分の設計をしていくと良いでしょう。
- EC2インスタンスの選択方針
- IPアドレスのアサインは自動か手動か
- Auto Scaling Groupとして構築するかどうか

### EBS
- EBSボリュームタイプの選択方針
- gp3やio1/2のボリュームタイプを使う場合は、スループット・IOPSの設定方針
- EC2インスタンスあたりのEBSボリュームは単一か複数か？複数なら、EBSボリュームを何単位で作成・アタッチするのか

### AMI
AMIの選択方針
- OSとしてなにを選択
- バージョンの選択方針

### IAM Role
IAMロールに関する設計です。
- IAMロールをどういう単位で作成するか
- 権限をどう付与するか?(インラインポリシーか、ポリシーを作成してそれをアタッチする形か)
- 共通で付与するポリシーがあればそのポリシー名

### Auto Scaling Group

## サーバ共通設計
サーバの中身の設計に入って行きます。まずは種別に関わらず共通の設計事項を書いて行きます。

#### OS
OSの設計を書きます。最低限書くのは以下かなと。
- ホスト名をどうするか()
- システムロケール
- タイムゾーン

- 追加でファイルシステムをマウントするのであれば
    - ファイルシステム
    - マウントポイント
    - 所有者・権限

#### 共通ミドルウェア
共通でインストールするミドルウェアがあればそれに関する設計を書きます。
- 共通ミドルウェア名と用途
- その設定に関する方針

## Webサーバ設計
## アプリケーションサーバ設計

## データストア
### データベース
### ストレージ

## 負荷対策装置
### ロードバランサ
### CDN

# 共通機能サーバ設計
## その他コアコンポーネント
### ドメインコントローラ
### ジョブ管理
## 非機能系サーバ
### 監視サーバ
### セキュリティソフト
### 踏み台
### ビルド・CICD

# その他非機能設計
## 稼働率
## RPO/RTO/RLO
## バックアップ・リストア
## BCP・DR
## セキュリティ
### データセキュリティ
#### 通信時暗号化
#### 保管時暗号化
#### アクセスコントロール
### 監査
### 脆弱性対策
### 攻撃への対策
#### ウィルス対策
#### WAF
#### IPS/IDS
#### DDoS対策
## ジョブ管理
ジョブ管理サーバーやサービスを導入する場合に書くことになる章です。<br>
どんなジョブをどうやって管理するのかを設計します。ジョブとは、スケジュールやイベントを契機にコンピュータに実行させる処理を指します。ジョブには大きく分けて2つの種類があります。

| 種別               | 説明                                 | 例                                                                      | 
| ------------------ | ------------------------------------ | ----------------------------------------------------------------------- | 
| 業務(アプリ)ジョブ | ユーザーさんの業務に関わるジョブ     | 日次の自動発注、月末の集計、FTPで置かれたファイルの内容のDBへの取り込み | 
| インフラジョブ     | 非機能系で主に運用保守に関わるジョブ | バックアップ、ログローテーション、ウィルススキャン                      | 

以下のようなことを記述します。
- ジョブ管理サーバ・サービスとして何を利用するか
- ジョブ管理の方針（業務ジョブは何で管理して、インフラジョブは何で管理）
- ジョブ一覧（多分、別ファイルにした方が良い）
### イベント管理
## ログ管理
## 監視
## 基盤・アプリ更新
## 性能・拡張性
