# 基本設計

基本設計とは、

## 基本設計のインプット・アウトプット
### インプット
前段階の成果物全てがインプットになるが、特に以下が無いと基本設計が行き詰まる。
- 非機能要件定義書

上記では足りないのが殆どなので、このフェーズでも議論や提案は必要

### アウトプット(成果物)
- 基本設計書


## 基本設計で記述すること
基本的に要件定義で出てきた要件をどのような方式・方針で実現するのかを記述するのが基本設計です。<br>
内容として求められるのは、これをインプットに詳細設計を書いていくことが出来ようにすることです。基本設計が完了したら、詳細設計の枠は過不足なく出来る状態になっているべきです。具体的には最低限以下のようなことが書いてあるべきです。
- システムを構成する要素と役割を漏れなく(詳細設計に書くサービス種別・数が決まります)
- 必須設定項目、デフォルト値と異なるオプション設計項目(各サービスについて、詳細設計に書く項目が決まります)
上記に加えて、以下もある程度書いてあるべきです
- それぞれの設計項目のパラメータを決定する為の要件(パラメータ値を決定する材料になります)

### 基本設計で注意するべきこと
PMやPLが注意するべき事、前提として聞いておいた方が良い事等
- 非機能要件定義書をもらいましょう
- メンバーと完成イメージを共有しましょう
- メンバーに書いてもらいたいことを具体的に指示しましょう。必要に応じてドラフトを書いてあげましょう。

メンバー・リーダーみんな気を付けるべきこと
- 詳細設計のインプットとなるようにある程度具体的な内容まで書きましょう
- 書いたら自分で読み返して、詳細設計としてどんな項目を書くことになるかイメージ出来るか確認しましょう

### 章立て
- システムの目的
- システム概要
    - システムの構成図
    - ソフトウェア一覧
    - 命名規則
    - タグ設計
- AWSアカウント設計
    - AWSアカウント構成
    - AWSリージョン構成
    - IAM ユーザ
    - アカウントセキュリティ・コンプライアンス
- ネットワーク設計
    - ネットワーク構成概要
    - VPC・サブネット構成
        - VPC設計
        - サブネット設計
    - ネットワーク通信要件
        - WAN通信
        - VPC Endpoint(AWS API通信)
        - インターネット通信
        - ネットワーク通信制御
            - ルートテーブル設計
            - ネットワークアクセスコントロールリスク(NACL)設計
            - セキュリティグループ設計
    - ネットワークロギング
        - VPC Flow Logs
        - Route53 Resolver log
    - ネットワーク基本設定(DNS,NTP等)
    - ドメイン
        - パブリックドメイン
        - プライベートドメイン
        - 名前解決連携
- サーバ系要件
    - 計算基盤
    - サーバ構成
    - OS
    - ミドルウェア
    - アプリケーションサーバ
    - DB
    - LB
    - CDN
    - ストレージ
- 非機能系要件
    - 可用性
        - 稼働率
        - RPO/RTO/RLO
        - BCP・DR
    - 性能・拡張性
        - オンライン性能
        - バッチ性能
        - 性能拡張
        - 容量拡張
    - セキュリティ
        - 脆弱性対策（パッチ）
	    - ウィルス対策
        - 攻撃防御どんな攻撃を想定するか、どんな対策をするか
        - 暗号化
        - 監査
    - 保守・運用性
        - 監視
        - ログ
            - 取得・保管対象ログ
                - アクセス分析系
                - 障害調査系
                - 監査系
            - 保管要件
                - 期間
                - 暗号化有無
        - バックアップ・リストア

以下から基本設計で書くことを章立てに沿って具体的に説明して行きます

---

# システムの目的
誰に何を提供するのが目的というようなことを書きます。以下のような要素が適宜入っていればいいんではないかと。
- システム主幹（誰が）
- 主なエンドユーザ（誰に）
- どんな機能を提供するのか（何を・どんなことを）
- 非機能について特筆することがあれば（どうやって）
- 補足情報があれば必要に応じて（Why, Where, When）

# システム概要
システムの全体像だったり、共通で適用できるような設計事項を書きます。

## システムの構成図
この設計書の中で設計するもの達を１枚以上の構成図で示します。1枚で収まるなら1枚で、規模が大きくて複数枚に分けないと描ききれないのであれば複数枚に分けるといいでしょう。例えば以下のような図があると思います。
- VPCの中だけの図
- AWSアカウント内のその他リソースも含めた図
- WANや外部連携先も含めた図
システムの利用者がどこからアクセスしてくるのか、運用保守のオペレータがどこからアクセスしてくるのかも分かるとよいでしょう。

## ソフトウェア一覧
システムで利用するソフトウェアの一覧です。OSに追加でインストールするミドルウェアや、パッケージソフトの一覧表を作ります。継続的に更新がかかるような環境ではソフトのバージョン番号までは書かない方が良いです。（個人的にはソフトウェア一覧は不要論を唱えています。サポート切れや脆弱性のあるソフトがないかのチェックに主に使われる資料だと思いますが、昨今のAWS環境ではSSMのインベントリとかで確認するのが良いんじゃないかなぁ......）

## 命名規則
各リソースにどんな命名をするのかです。正直これが一番難しいんじやないかな。。。どんなリソースにも適用できる1つのパターンを作ろうとすると詰むので、なにはこういうパターンで命名するというようなものを作成することになるかと。AWSリソースの命名に加えて、コンピュータのホスト名も命名する場合があります。<br>
注意すべきは、名前に使える文字の種類（大文字や、一部の記号、非アルファベット文字が使えるかどうか。AWSリソースによって使えたり使えなかったりするので注意が必要）や文字数（例えば、Windowsのホスト名は15文字まで、ALB名は32文字まで等）の制約です。

## タグ設計
各AWSリソースにどんなタグ付けをするのかを書きます。まず、どんな目的でタグをつけるよという事を決めて書きます。そして、タグキーの一覧と値の例を表にしてあげます。タグを付ける目的については、お客さんと相談することになりますが、タグの利用目的が決めきれなそうであれば詳細は運用設計で定義するとしてしまっても良いです。<br>
以下は代表的なタグの目的です。適宜取捨選択。
- コスト配分
- リソース整理
- 自動化
- アクセス制御

参考
- [AWSリソースのタグ付け](https://docs.aws.amazon.com/ja_jp/general/latest/gr/aws_tagging.html)


# AWSアカウント設計
AWSアカウントの、構成、IAMユーザ、セキュリティ・コンプライアンス系サービスといった、システムの機能に関わらない部分の設計を記述します。

## AWSアカウント構成
システムが関係するAWSアカウントとその役割を記します。
- AWSアカウントを分割する基準
- AWSアカウントの一覧(アカウント種別、役割の説明)
- マルチアカウント構成なら図もあると親切でしょう、簡単でいいので

システムの垣根を超えた高度なマルチアカウント構成(システム間の共通機能アカウントがあったり、複数システムを纏めるアカウントがあったり)にするのであれば、AWSアカウント設計は別のドキュメントに纏めるのでも良いと思います。

## AWSリージョン構成
AWSリージョンの利用に関する方針を記します。以下について言及していれば良いかと。
- 主に使用するリージョン
- 主たるリージョンにサービスがない場合、どのリージョンを使用するか
- リージョン障害に備えたDR用のリージョン(あれば)

## IAMユーザ
IAMユーザ・グループ・ポリシーについて設計します。以下のような項目を書きます。
- IAMユーザ、IAMグループの作成単位
- 権限付与方法(ユーザではなくグループにポリシーを割り当てるとか、例えばスイッチロールして管理者権限得るとか)
- IAMポリシーの設計方針
    - まず最低限の権限はなにか
    - 管理権限はどの程度付与するか
    - 権限はホワイトリスト方式で付与するか、ブラックリスト形式で制限するか
    - どのくらい細かくポリシーを書くか
- パーミッションバウンダリーを使うかどうかと使い方
- IAMユーザのパスワードポリシー、MFAの使用を強制するか
これらはシステム構成よりも運用体制の影響が大きい部分なので、運用設計で設計することにしても良いと思います。

参考
- [IAMのベストプラクティス](https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/IAMBestPracticesAndUseCases.html)

## アカウントセキュリティ・コンプライアンス
AWSアカウントレベルでの、監査・変更検知・セキュリティ対策について設計します。CloudTrail,AWS Config,GuardDuty,Macie等が設計対象となります。
これらも運用設計で設計する事にしても良いと思います。


# ネットワーク設計
VPCやDirectConnect、インターネット接続やセキュリティグループといったネットワークに関する設計です。<br>
設計書では、結論から先に書くということでVPC・サブネット構成から通信要件という順序で進んでいますが、実際に設計を行なう順序は通信要件を整理してから、それに合わせたVPC・サブネットの構成とルートテーブル・NACL・SGの作成割り当て

## ネットワーク構成概要
まず、インターネット,WANを含むシステムのネットワークの全体像と基本的なネットワーク要件（外部接続先、NWセキュリティの方針）を描きます。
- 概要説明
- ネットワーク構成図

## VPC・サブネット構成
VPCとサブネットの構成を書きます。

### VPC設計
VPCとそのCIDRについて書きます。
- VPC一覧とそのCIDR・用途等
- DNSホスト名とDNS解決をEnableにするか(基本両方Enableにしておいた方がいい)<br>
  [VPCのドキュメント](https://docs.aws.amazon.com/ja_jp/vpc/latest/userguide/vpc-dns.html)より
  > Amazon Route 53 のプライベートホストゾーンで定義されたカスタム DNS ドメイン名を使用する場合や、インターフェイス VPC エンドポイント (AWS PrivateLink) でプライベート DNS を使用する場合は、enableDnsHostnames 属性と enableDnsSupport 属性の両方を true に設定する必要があります。

### サブネット設計
サブネットをどのように切るのかを設計します。設計にあたってはまず通信制御を整理すると良いでしょう。なぜなら、サブネットは通信要件が異なるから分けるというのが基本だからです(サブネットは、ルートテーブルとNACLを割り当てる単位なので、通信出来る相手の違いをつけることが出来ます)
- サブネットの分割方針
- CIDRの割り当て方針(例えばVPC CIDRの先頭の方からネットワーク切っていくかとかとか)
- サブネットとそのCIDR, Availability Zone

## ネットワーク通信要件
### WAN通信
各VPCが通信するVPC外のプライベートネットワーク(他VPC含む)があればそれらを漏れなく挙げます。
そして、それらと何を介して繋げるか(VyOS等でのセルフマネージドVPN,AWSマネージドVPN, DirectConnect, DX Gateway, Transit Gateway)を設計します。
- VPC外プライベートネットワーク一覧
- VPCと何を介して繋げるか

### VPC Endpoint
インターネット接続がない中でも各AWSサービスのAPIを呼び出す為に使用する、VPC Endpointに関する設定です。
- VPCエンドポイント一覧（サービス・Gateway型かインタフェース型か）
- VPCエンドポイントポリシーを設定するか、設定するならどんなポリシーか?(セキュリティポリシー上厳しくする理由があればポリシー設定しますが、特になければエンドポイントポリシーは設定市内で良いでしょう)
- インタフェース型VPCエンドポイントについては、AZ構成、プライベートDNS名オプションを有効にするか(プライベートDNS名オプションは基本有効化です)

### インターネット通信
インターネットへの通信を出来るようにするかや、どんなネットワーク経路でインターネットと通信するか(Internet GatewayをVPCに付けない場合も稀によくある)を設計します。
- インターネットと通信させるか否か
- 何を経由してインターネットと通信させるか

### ネットワーク通信制御
これまで挙げて来たサブネットとVPC外ネットワークとの間の通信要件(通信できるようにする・しない)を整理して、通信制御方針、つまりルートテーブル・NACL・SGをどのように組み合わせて通信要件を実現するのかを設計します。
- 通信要件まとめ(各サブネットが他のどんなネットワークと通信出来るか)
- 通信制御方針

#### ルートテーブル設計
- どんな単位で作成、割り当てするか

#### ネットワークアクセスコントロールリスト(NACL)設計
- どんな単位で作成、割り当てするか

#### セキュリティグループ設計
- どんな単位で作成、割り当てするか

## ログ
ネットワーク関係のログについてです。取る取らないという要件は要件定義のログ要件で定義したものです。ここがまだ決まっていないのであれば、この基本設計フェーズで決めるか、運用設計フェーズで決めるということになります。

因みにですが、VPCフローログとRoute53リゾルバーログをGuardDutyで検査させたいだけであれば、ユーザ側で取得する設定は不要です。
- [GuardDutyのデータソース](https://docs.aws.amazon.com/ja_jp/guardduty/latest/ug/guardduty_data-sources.html#guardduty_vpc)

### VPC Flow Logs
どんなパケットがVPC内を行き来しているかのログです。VPC内のEC2等のインスタンスやELB達の仮想ネットワークインタフェースの間を行き来するIPトラフィックの情報(例えばsource/destinationのIP/Port, SGもしくはNACLによってACCEPTされたかREJECTされたか)を記録出来ます。主に以下の目的で使用できますので、どんな目的をもってログ取得するかお客さんと話し合いましょう。
- トラブルシューティング
- SG/NACLの穴あけの参考情報
- 監査

設計としては、以下のようなことを書くと良いでしょう。
- VPC Flow Logsを取得するかどうかと取得の目的
- 取得する範囲(VPC, サブネット, ACCEPT/REJECT)
- ログフォーマット(デフォルトかカスタムか)
- 保存先(S3かCloudWatchLogs、もしくはその両方)
- 保存の為の権限周りの設定をどうおこなうか([S3ならバケットポリシーの設定](https://docs.aws.amazon.com/ja_jp/vpc/latest/userguide/flow-logs-s3.html#flow-logs-s3-permissions)の必要がありますし、[LogsならIAMロールを付与する](https://docs.aws.amazon.com/ja_jp/vpc/latest/userguide/flow-logs-cwl.html#flow-logs-iam)必要があります)
- 保存先がS3の場合は、分析ワークロードの為のオプション設定(ファイルフォーマットをparquetにするかや、Hive互換のプレフィックスをオブジェクト名に付けるか)が出来ます。単なる監査だけではなく、分析の為にFlowLogsを使用する場合は、このオプションについても設計した方が良いですが、基本は設定不要です。

保存先をS3にするかCloudWatchLogsにするかですが、Logsは手軽に検索できるのでトラブルシューティングに向いていますがその分保管にかかる料金は高いです、S3は料金面で有利なので監査のような長期保管用途向きです。なので、例えばLogsはトラブルシューティング用として1ヶ月程度の保存期間として、S3にも監査用として数年間保存するというような設計にも出来ます。

参考
- [フローログレコード](https://docs.aws.amazon.com/ja_jp/vpc/latest/userguide/flow-logs.html#flow-log-records)
- [フローログの制限事項](https://docs.aws.amazon.com/ja_jp/vpc/latest/userguide/flow-logs.html#flow-logs-limitations)

### Route53 resolver log
VPC内のリソースが行なうDNSクエリのログです。VPC内のEC2インスタン等がRoute53リゾルバーを使ってどのような名前解決を行なったかについての情報(名前解決を試みたインスタンスID,解決対象のFQDN,クエリの成否等)を記録出来ます。<br>
EC2インスタンスがどんなFQDNを解決しているのかを記録・監視する事で、セキュリティ対策(例えばシステムが乗っ取りを受けた場合にアクセスされる恐れのあるサイト名をDNSでクエリしていないか？)や、トラブルシューティング等に利用できます。
- 監視
- 監査
- トラブルシューティング

設計としては、以下のようなことを書くと良いでしょう。
- Route53 resolver logを取得するかどうかと取得の目的
- 取得対象のVPC
- 保存先(S3、CloudWatchLogs、Kinesis Data Firehoseのどれか)
- 保存の為の権限周りの設定をどうおこなうか(例えば[S3が保存先ならバケットポリシーの設定が必要](https://docs.aws.amazon.com/ja_jp/Route53/latest/DeveloperGuide/resolver-query-logs-choosing-target-resource.html)です)
 
参考
- [AWSブログ記事](https://aws.amazon.com/jp/blogs/news/log-your-vpc-dns-queries-with-route-53-resolver-query-logs/)

## ネットワーク基本設定(DNS,NTP等)
VPCと関連付けるDHCPオプションセットに関わる設定です。主にサーバをActiveDirectoryドメインに参加させる場合に設定することになる項目です。AD参加しないのであれば設計不要です。DHCPオプションセットはデフォルトで良いのであれば、デフォルトを使用するというサクッとした書き方で良いと思います、カスタムで作るのであれば以下のようなことを書きます。
- カスタムのDHCPオプションセットを作成する単位とその目的
- DHCPオプションセットの設定
    - ドメイン名(ADドメイン名です)
    - DNSサーバ(ドメコンのIPです)
    - NTPサーバ(ドメコンのIPが基本です)

参考
[公式ドキュメント](https://docs.aws.amazon.com/ja_jp/vpc/latest/userguide/VPC_DHCP_Options.html)

## ドメイン
DNSのドメインやActive Directory Domain Serviceについての設計です。<br>
インターネットに公開するサービスか、もしくはWAN等のローカルネットワークに対してサービスを提供する場合、サービスの利用者はDNS名を解決してアクセスしてくることが基本です。この名前解決を利用者にどのように提供するかを設計します。ここで、エンドユーザがどこからどのように名前解決を行なうかをしっかり考えて設計しないと名前解決が出来ないということになりかねないので注意が必要です。以下のようなことを明らかにして設計に取り掛かりましょう。
- サーバ・クライアントが直接参照するDNSフルサービスリゾルバ
- サーバ・クライアントが解決する必要がある全てのドメイン(CNAMEの参照先を含む)
- 各ドメインの権威DNSサーバは何になるか
- 上記DNSフルサービスリゾルバと各権威DNSサーバ間の通信・転送

### パブリックドメイン
パブリックドメイン（インターネットから解決できるDNS名）をシステムに割り当てるのであれば書くべき項目です。パブリックドメインを使って、どのようにシステムの名前をユーザーに解決してもらうかの設計を設計します。以下のようなことを書きます。
- 取得するドメインの名前
- ドメインをホストするDNSサービス(基本はRoute53のパブリックホステッドゾーンかと)
- サービスのFQDN（すべてのレコードを書く必要はないです。それは詳細設計に書くか台帳を作るかで良いかと）
- その他レコードの設定方法に特記事項があれば(例: Aliasレコード、フェイルオーバー設定、etc.)

この際に注意するべきなのは、[Zone Apex(ネイキッドドメイン)](https://e-words.jp/w/Zone_Apex.html)に、CNAMEレコードを登録するように設計しないことです。Zone ApexにCNAMEレコードを設定することは出来ない為です。CloudFrontやELBとRoute53の組み合わせであればAliasレコード(実質Aレコード)で対応出来ますが、それ以外の組み合わせの時には気を付けた方が良いです。

### プライベートドメイン
プライベートなドメイン(VPC内部のみ、もしくはDX等で繋がったWAN内のみで解決出来るドメイン名)を、システムの為に用意するのであれば書くべき章です。プライベートドメインを用意する場合にも以下の2種類が考えられます。

| プライベートドメイン            | 説明                                                                                                                                                   |
| ------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Active Directoryドメイン        | WindowsのActive Directory Domain Servicesによるドメインです。DNSのローカルドメインも兼ねます。基本ドメインコントローラーがVPC内のDNSサーバとなります。 |
| Route53 Privateホステッドゾーン | DNSのプライベートドメインです。Route53でVPC群に紐づけたプライベートホステッドゾーンを作ることになります。                                              |

以下のようなことを書きます。
- 何の為にプライベートなドメインを用意するのか(目的)
- プライベートドメインを上表のどちら(AD?Route53?)で実装するのか
    - ADドメインの場合は、ドメインコントローラーは何か(Directory Service, EC2, オンプレADサーバ)
- プライベートドメインのドメイン名
- プライベートドメイン名が解決できるネットワークの範囲

ここで注意すべきは、特にADドメインを用意する場合です。
- AWS Directory Serviceではドメインは新規に作成となり、オンプレのドメインと同一にすることは出来ません。オンプレドメインと連携するには[外部またはフォレストの信頼関係](https://viewse.blogspot.com/2012/11/vs.html)を結ぶ必要があります。[サイト](https://blogs.manageengine.jp/what_is_site/)は構成出来ません。当然設計することは増えます。
- AWS Directory Serviceでは、ドメインの管理者は真のDomainAdminsではありません。これはマネージドサービスであるが故の制約ですが、ドメインを運用していくのに十分な権限が管理者アカウントには付与されています。とはいえ、上記の制約も含めてドキュメントで詳しく調べて要件に合うかを検討するべきです。
- EC2,オンプレADサーバとする場合は、可用性設計が重要です。ドメインコントローラーはコアコンポーネントであり、障害が起こるとシステム全体が機能停止に陥る可能性が高いです。ゆえに高い可用性が必要です。
    - EC2の場合は、ドメコンサーバは冗長構成を取るというような設計となるかと
    - オンプレADサーバの場合は、VPCからオンプレへのネットワークには高い可用性を確保する設計となるかと

### 名前解決連携
VPCとオンプレ等のプライベートネットワークで別々のプライベートドメインを使って、尚且つドメインをまたがって名前解決する必要がある場合に書くべき項目です。<br>
これには、以下のようなパターンがあります。
- VPC内のEC2インスタンスに、オンプレ側のプライベートドメインの名前を解決させたい
- オンプレのサーバ・クライアントに、VPC側のプライベートドメインの名前を解決させたい
- その両方をさせたい
方式としては以下のような選択肢があるかと思います
- DNSサーバ(十中八九ADドメインコントローラです)をVPC上に構築して条件付きフォワーダーを設定する。構築する選択肢は以下のようなものがあります。
    - AWS Directory Service
        - Simple AD
        - MS AD Standard
        - MS AD Enterprize
    - EC2インスタンス上に構築したセルフマネージドなADサーバ
- [Route53リゾルバーエンドポイント](https://docs.aws.amazon.com/ja_jp/Route53/latest/DeveloperGuide/resolver.html)を使う

どの方式を選ぶのかは、要件・性能・可用性・料金面で変わって来るので一概にこれを選べば良いとは言えません。どの方向で連携させるか、ADドメインをどのくらいの範囲で使用するかといった要件をしっかり確認して設計を行ないましょう。


# アプリケーションサービス設計
サービスを構成するロードバランサーやサーバー、データベース等の設計です。どんなサーバ群でサービスを提供するかを設計します。また、それらのパラメータを決定する為の方針を定めます。<br>
ここから先は、システムの規模や基盤によって色々なバリエーションが出てくるゾーンに入ってきます。なので、章立ては参考程度にしてもらって、システム毎にどのような章立てが良いか考えて貰った方が良いかと思います。例えば、場合によってはシステムがいくつかのサービスに分かれていることもあると思います。その場合は、サービス毎に別々の章に分けるという章立ても検討すると良いかと。

## 概要
アプリケーション基盤としてどんな構成にするか、基本方針を示します。

### 計算基盤
計算基盤として何を使用するかを書きます。
EC2インスタンスなのか、コンテナ（ECSかEKSか。データプレーンはEC2かFargateか）、Lambdaを使ってサーバレスかといったことを書きます。

### サーバ構成
アプリケーションのサービスがどんなサーバ等で構成されるかを記述します。
- アプリケーションサービス構成図(CDN, Load Balancer含む)
- サーバ一覧表
- CPUのアーキテク茶は何を使用するか？(X86_64を使うのであれば言及する必要ないかもしれませんが、ARM64を使うのであれば言及した方が良いでしょう)

サーバ一覧のレベル感は、例えば以下のような感じで良いかなと

| サーバ                 | 基盤・サービス            | 台数                          | 備考（あれば） | 
| ---------------------- | ------------------------- | ----------------------------- | -------------- | 
| CDN                    | CloudFront                | 1                             |                | 
| Webサーバ              | S3                        | 1                             |                | 
| ロードバランサー       | Application Load Balancer | 1                             |                | 
| アプリケーションサーバ | EC2                       | 2台以上（Auto Scaling Group） |                | 
| BIサーバ               | EC2                       | 1                             |                | 
| DBサーバ               | RDS                       | マルチAZ 1台                  |                | 
| 分析用DBサーバ         | RDSリードレプリカ         | シングルAZ 1台                |                | 

## コンテナオーケストレーション設計
ECSやEKSのようなコンテナオーケストレータを使う場合は書くべき章です。
- コントロールプレーン(コンテナオーケストレーター)としてなにを選ぶか(ECSかKubernetesかの2択)、マネージドサービス(EKS)を使うか
- データプレーンとしてなにを使用するか(EC2 or Fargate)
- コンテナイメージレポジトリとしてなにを使用するか(プライベートに使うと思うんで基本ECR一択かなと)

### クラスター設計
- クラスターをどんな単位で構築するか
- クラスターのバージョン選択方針
- EKSの場合はクラスターのエンドポイントをプライベートにするかパブリックにするか(kubectlをインターネットから打てるようにするか、VPC内からのみ打てるようにするか)
- コントロールプレーンのログについて

### データプレーン設計
アプリケーションコンテナを動かすことになるデータプレーンに関する設計です。EC2インスタンスを選ぶかFargateを選ぶかで設定しないといけない項目が変わってきます。

*EC2インスタンスを選ぶなら*
- OSは何を使用するか(まぁ基本AmazonLinux2のECSかEKS最適化されたやつかと)
- [AutoScalingGroupの設計](#auto-scaling-group)と同じ項目

*Fargateを選ぶなら*
- OSは何を使用するか(AmazonLinux2一択のようです。Windowsコンテナでないのであればですが)

### コンテナイメージ・レジストリ設計
コンテナのイメージとそれを保存するレジストリに関する設計です。
- レジストリとして何を使用するか(十中八九、プライベートなレジストリとしてECRを使用すると言う設計になると思います)
- レポジトリ(イメージの名前にあたる)をどんな単位で作成するか
- イメージのバージョンをどんな形式のタグで管理するか
- タグの変更可能性(Tag immutability)に関する設計
- 脆弱性のスキャンに関する設計
- 暗号化設定

### IAM Role
ECSやEKSを利用する際には、IAMロールが多数登場することになります。これは人が使うものではなく、ECS,EKSのサービスやコンテナ達が引き受けるIAMロールです。ここでは、こういうIAMロールを、こういう用途で作成するよということを書くことになります。(いくつかのロールはマネジメントコンソールでクラスター作成していると自動で作られたりするので注意した方が良いです。特に、開発環境・本番環境が別AWSアカウントで、CloudFormationで構築を行なっていたりする場合、開発はお試しでマネコンポチポチで自動的に作られてたIAMロールが本番アカウントにはなくって、CloudFormationでの構築が失敗するという事をよく目にします)

- コントロールプレーンに付与するIAM Role
    - ECSのサービス自体に付与するIAM Role([ECS Service Linked Role](https://docs.aws.amazon.com/ja_jp/AmazonECS/latest/developerguide/using-service-linked-roles.html))
    - EKSの場合は、[KubernetesクラスターにIAMロールを付与](https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/service_IAM_role.html)します。そして、[Kubernetesのサービスアカウント(Kubernetesクラスタ内での権限管理・付与の仕組み)とIAMロールとを連携させる必要があります](https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/iam-roles-for-service-accounts.html)。
      更に、Fargateをデータプレーンに使用する場合は、[EKSポッド実行IAMロール](https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/pod-execution-role.html)
- データプレーンのEC2インスタンスに付与するIAM Role
    - [ECSコンテナインスタンスのIAMロール](https://docs.aws.amazon.com/ja_jp/AmazonECS/latest/developerguide/instance_IAM_role.html)
    - [EKSノードのIAMロール](https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/create-node-role.html)
- データプレーン上で動くサービス側のエージェントに付与するIAM Role
    - [ECSタスク実行IAMロール](https://docs.aws.amazon.com/ja_jp/AmazonECS/latest/developerguide/task_execution_IAM_role.html)
- アプリケーションのコンテナに付与するIAM Role
    - [ECSタスク用の IAM ロール](https://docs.aws.amazon.com/ja_jp/AmazonECS/latest/developerguide/task-iam-roles.html)
    - [EKS IAM ロールをサービスアカウントに関連付ける](https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/specify-service-account-role.htmll)

参考
- [ECSのIAM](https://docs.aws.amazon.com/ja_jp/AmazonECS/latest/developerguide/security-iam.html)
- [EKSのIAM](https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/security-iam.html)

## EC2インスタンス設計
コンテナを使わず、EC2インスタンス上にアプリをデプロイする場合に書く章です。EC2インスタンス関する設計を記していく章です。まずはサーバ共通の設計をしてから、各役割別に異なる部分の設計をしていくと良いでしょう。
- EC2インスタンスのタイプの選択方針(m6iかr6iかとかです。サーバで上で動くアプリケーションがメモリとCPUをどのようなバランスで要求するのかをアプリ担当に聞いて選択します)
- IPアドレスのアサインは自動か手動か
- Auto Scaling Groupとして構築するかどうか

### EBS
- EBSボリュームタイプの選択方針
- gp3やio1/2のボリュームタイプを使う場合は、スループット・IOPSの設定方針
- EC2インスタンスあたりのEBSボリュームは単一か複数か？複数なら、EBSボリュームを何単位で作成・アタッチするのか

### AMI
AMIの選択方針
- OSとしてなにを選択
- バージョンの選択方針

### IAM Role
IAMロールに関する設計です。
- IAMロールをどういう単位で作成するか
- 権限をどう付与するか?(インラインポリシーか、ポリシーを作成してそれをアタッチする形か)
- 共通で付与するポリシーがあればそのポリシー名

### Auto Scaling Group
AutoScalingGroupに関する設計
- Launch Templateをどんな単位で作成するか
- Launch Templateでどんな設定項目を管理するか
- インスタンス購入オプションとしてOn-demandのみか、Spotを使うか？
- ロードバランサにアタッチする場合はどのターゲットグループに紐づけるか
- ヘルスチェックはどうするか(EC2, ELBの2択ですが、ELB配下に配置するインスタンスならELB,そうでないならEC2が良いでしょう)
- オートスケーリンググループのグループメトリクスを取得するか(取得した方がいいと思います)
- スケールイン・アウトを何に従って行なうか(Target Tracking scaling policyを使用するか、CloudWatchアラームと連携してのスケールか)

## サーバ共通設計
サーバの中身の設計に入って行きます。まずは種別に関わらず共通の設計事項を書いて行きます。

#### OS
OSの設計を書きます。最低限書くのは以下かなと。
- ホスト名をどうするか(デフォルトのホスト名で良いならその方が良いです。AutoScalingさせる場合は、デフォルトのホスト名にするべきでしょう)
- システムロケール
- タイムゾーン

- 追加でファイルシステムをマウントするのであれば
    - ファイルシステム
    - マウントポイント
    - 所有者・権限

#### 共通ミドルウェア
共通でインストールするミドルウェアがあればそれに関する設計を書きます。
- 共通ミドルウェア名と用途
- その設定に関する方針
    - 何かsystemdでenableにするサービスがあれば
    - 設定ファイルの中にこういう設定をしましょうというのがあれば
    - 設定ファイルが複数あるようなミドルウェアもあったりするので、どのファイルに設定を書くのかも書ければ書いた方が良いです

## Webサーバ設計
- HTTPサーバとして何を使う?(Nginx, Apache HTTP Server)
- systemdでenableにする？
- リッスンポート・プロトコル
- http/2を有効にするかどうか(gRPCをアプリが使っていない限りはWebサーバ側ではhttp/2は有効化しないで良いと思います)
- ユーザとUlimit
- ドキュメントルートと権限
- 設定ファイルの置き場所とかどのファイルにどんなことを書き分けるとか
- バーチャルサーバ
- リバースプロキシ(あれば)
- リダイレクト
- エラーページ
- Keep Alive Timeout
- ログ
    - アクセスログフォーマット
    - アクセスログ出力先
    - アクセスログ抑制設定
        - ALBのヘルスチェッカーのアクセスログが大量に出たりするので、それはノイズなので抑制したいという要望が結構あります
        - Route53ヘルスチェックをしている場合も同様
    - ログローテーション
        - logrotateのデフォルトから変更する場合は言及するべきですが、CloudWatchLogs等に刈り取らせてそこでライフサイクル管理するのが良いと思います。そうできれば、logrotateの設定はデフォルトのままで良いかと、yumでインストールしていれば`/etc/logrotate.d`の中にログローテーション設定作ってくれるので。
- セキュリティ系の設定
    - ミドルウェア情報の制限
- その他パフォーマンス系チューニング
    - non blocking I/Oとか?

## アプリケーションサーバ設計
- 何を使う?
- systemdでenableにする？
- リッスンポート・プロトコル
- ユーザとUlimit
- ディレクトリと権限
- 設定ファイルの置き場所とかどのファイルにどんなことを書き分けるとか(使用するアプリ言語・サーバでまちまちなのでここは都度調べましょう)
- ログ
- セキュリティ系の設定
    - ミドルウェア情報の制限
- その他パフォーマンス系チューニング
    - 起動時の引き数とか、設定ファイルの起動パラメータとか

## データストア
データのストレージに関する設計です。RDS等のデータベースやS3,EFSのようなストレージに関する設計となります。

### データベース
データベースサーバを設計していきます。基本的にRDS DBインスタンスを構築する時に設定するパラメータについて方針を与えることを意識して設計項目を書きます
- 使用するRDBMSとバージョン
- ライセンス調達形式
- サービスはなにを使うか?(RDS, Aurora)
- AZ構成
- ストレージ(タイプ・サイズ)
- ストレージ暗号化
- リッスンポート
- OracleならSID(DBインスタンス構築時の初期DB名がSIDになる、省略するとデフォルト値として`ORCL`となる)
- Oracleならマルチテナントで動かすかどうか
- 文字セット/照合順序
- タイムゾーン
- 認証方法(AD認証やIAM認証と連携できるDBMSもある)
- パラメータグループ
- オプショングループ
- ログ
- 拡張モニタリング
- パフォーマンスインサイト
- バックアップウィンドウ
- メンテナンスウィンドウ
- 自動マイナーバージョンアップグレード
- 削除保護

### ストレージ
アプリケーションでS3やEFSのようなストレージサービスを使用する場合に書く
- 何をどんな用途でつかうか
- 選定理由と選んだサービス(S3,EFS)の概要
- S3に関わる設計
    - バージョニング設定
    - デフォルト暗号化
    - アクセスログ(取得するならCloudTrailデータ証跡で取るのがお勧めです)
    - アクセスコントロール(ブロックパブリックアクセスを有効にするか、バケットポリシーで細かい制御を行なうか)
    - バケットライフサイクル
- EFSに関わる設計
    - パフォーマンス・スループットモードはどうするか
    - ライフサイクル設定をするかどうか(具体的なライフサイクル設定は必ずしもここでする必要はないです)
    - 暗号化するかどうか
    - バックアップに関する設定
    - マウントターゲットをどのサブネットに作成するか(マウントするEC2等と同一AZにマウントターゲットがある必要があります)
    - アクセスポイントを利用するかどうか(マウントターゲットとアクセスポイントは別物です)

## 負荷対策装置
ロードバランサー(ALB等)やCDN(CloudFront等)の設計です。これらの内使用するものがあれば書くことになります。

### CDN
今回の資料ではCDNの設計は範囲外とします。<br>
CDNは、ユーザの多いWebサイトには不可欠ですが、しっかりとした運用が不可欠であり、もし間違った設定をしてしまうとアプリケーションに致命的な不具合を起こす可能性があります。なので、とりあえずCloudfrontを入れておけば安牌というようなものでは決してありません。もしCDNを導入する場合は、アプリやWebコンテンツの担当者としっかり連携しながら設計しましょう。<br>
不具合が起こってしまう例ですが、これは主にコンテンツキャッシュの設定に問題があることによって引き起こされます。CDNがエッジのキャッシュを返すかどうか（つまりあるリクエストと別のリクエストのレスポンスが同じデータか）は、色々な条件で判断されます(メソッド, パス, クエリストリング, Cookie)。これらを正しく設定しないとCDNが効果を発揮できなかったり、最悪の場合は顧客情報の流出を発生させることもありえるということを認識しておきましょう。

参考
- [【図解】CDNとは？仕組みと技術の基礎知識](https://www.kagoya.jp/howto/it-glossary/web/cdn/)<br>
- [CDN切り替え作業における、Web版メルカリの個人情報流出の原因につきまして](https://engineering.mercari.com/blog/entry/2017-06-22-204500/)
- [CDN で高いHIT率にするチューニングとは](https://blog.redbox.ne.jp/cdn-high-hitrate-cookie-query.html)

### ロードバランサ
- ロードバランサーとして何を選択するか(ALBかNLBか)
- インターネット向けかインターナル向けか？
- リスナープロトコル
- 各リスナープロトコル毎のデフォルトアクションをどうするか、追加のルールを使って
  (デフォルトでは3XXや4XXの固定レスポンスを返して、追加のルールでホストヘッダーを見てからWebサーバ等に転送するという設計の方が良いかなと思います)
- ターゲット
- アクセスログ
- ターゲットのヘルスチェック(プロトコル、HTTP/sヘルスチェックの場合はパスとステータスコード)
- スティッキーセッションを有効にするか(ALBの場合)

# 共通機能サーバ設計
各サーバが共通で利用することになるサーバの設計を行ないます。

## その他コアコンポーネント
サービスの機能に関わってくるコンポーネントの設計を行ないます。例えばですが、以下のようなサーバを構築するのであれば書くことになる章です。
- ドメインコントローラ
- ジョブ管理サーバ

### ドメインコントローラ
ドメインコントローラを構築するのであれば書くべき項目です。
- ドメコンの可用性
    - サーバ台数
    - どのサブネットに構築するか
- 条件付きフォワーダのようなDNS設定をすることがあれば、それに関する設計(どんなドメインに対するクエリはどのDNSサーバにフォワードするか)
<br>以下はドメコンをAWS Directory Serviceで構築するのであれば書くべき項目です
- 選択するMSADのエディション(StandardかEnterprize)
<br>以下はドメコンをEC2インスタンスで構築するのであれば書くべき項目です
- ドメコンサーバにおいて追加する役割

### ジョブ管理
ジョブ管理の為にサーバ(例えばJP1AJS管理サーバ)を構築するのであれば書くべき項目です。
- ジョブ管理サーバの可用性
    - サーバ台数
    - どのサブネットに構築するか
- インストールするジョブ管理サービスプログラム
- ジョブ管理サービスが依存するパッケージがあれば、それらをインストール対象として列挙
- その他、OSやミドルウェアの設定としてジョブ管理サービスが必須・推奨とするような設定があれば

## 非機能系サーバ
サービスの機能に関わらない、非機能系のコンポーネントの設計を行ないます。例えばですが、以下のようなサーバを構築するのであれば書くことになる章です。
- 監視サーバ
- セキュリティソフト管理サーバ
- 踏み台サーバ
- ビルド・CICDサーバ

### 監視サーバ

- 監視サーバの可用性
    - サーバ台数
    - どのサブネットに構築するか
- インストールする監視サーバプログラム
- 監視サーバプログラムが依存するパッケージがあれば、それらをインストール対象として列挙
- その他、OSやミドルウェアの設定として監視サービスが必須・推奨とするような設定があれば
- 監視エージェントを各サーバにインストールして使用する場合、対象となるサーバにエージェントをインストールすると言及しておくと良いでしょう。、

### セキュリティ管理サーバ

- セキュリティ管理サーバの可用性
    - サーバ台数
    - どのサブネットに構築するか
- インストールするセキュリティ管理サーバプログラム
- セキュリティ管理サーバプログラムが依存するパッケージがあれば、それらをインストール対象として列挙
- その他、OSやミドルウェアの設定としてセキュリティ管理サービスが必須・推奨とするような設定があれば
- セキュリティ管理エージェントを各サーバにインストールして使用する場合、対象となるサーバにエージェントをインストールすると言及しておくと良いでしょう。

### 踏み台
踏み台サーバを構築する場合は書くべき項目です。
- 作業用ユーザを作成するか
- 作業用共用ディレクトリを作成するか
- 踏み台サーバで行なうセキュリティ・コンプライアンス上の措置
    - (例)ターミナルログの取得
ここまで書いてあれですが、最近のAWS環境では、踏み台サーバは使わずSSMセッションマネージャを使用する方が良いかと思います。ターミナルログもCloudWatchLogsに出力できるし。

### ビルド・CICD
アプリケーションのビルドやCICDに使用されるサーバを構築する場合は。
EC2のようなサーバ上に構築するとなるとJenkinsがメジャーな選択肢となると思います。
AWSのサービスであれば、CodePipeline, CodeBuild, CodeDeployといったサービスの組み合わせになります。
他には、Circle CIといったサービスや、Github ActionsというCICDサービスもあるので、一から選択するとなると色々な選択肢があるので少し大変です。
何を選択するかの基準は、費用面もあると思いますし、既存の資産やスキルを流用しやすいものを選択するということになるかと思います。

# その他非機能設計
## 稼働率
## RPO/RTO/RLO
## バックアップ・リストア
## BCP・DR
## セキュリティ
### データセキュリティ
#### 通信時暗号化
#### 保管時暗号化
#### アクセスコントロール
### 監査
### 脆弱性対策
### 攻撃への対策
#### ウィルス対策
#### WAF
#### IPS/IDS
#### DDoS対策
## ジョブ管理
ジョブ管理サーバーやサービスを導入する場合に書くことになる章です。<br>
どんなジョブをどうやって管理するのかを設計します。ジョブとは、スケジュールやイベントを契機にコンピュータに実行させる処理を指します。ジョブには大きく分けて2つの種類があります。

| 種別               | 説明                                 | 例                                                                      | 
| ------------------ | ------------------------------------ | ----------------------------------------------------------------------- | 
| 業務(アプリ)ジョブ | ユーザーさんの業務に関わるジョブ     | 日次の自動発注、月末の集計、FTPで置かれたファイルの内容のDBへの取り込み | 
| インフラジョブ     | 非機能系で主に運用保守に関わるジョブ | バックアップ、ログローテーション、ウィルススキャン                      | 

以下のようなことを記述します。
- ジョブ管理サーバ・サービスとして何を利用するか
- ジョブ管理の方針（業務ジョブは何で管理して、インフラジョブは何で管理）
- ジョブ一覧（多分、別ファイルにした方が良い）
### イベント管理
## ログ管理
## 監視
## 基盤・アプリ更新
## 性能・拡張性
